---
title: "ãªãœDDDã«ã¯CQRSãŒå¿…é ˆãªã®ã‹"
emoji: "ğŸŒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ddd", "cqrs", "python"]
published: false
---

# æ¦‚è¦
DDDã®è§£èª¬è¨˜äº‹ã¯ã‚ˆãã‚ã‚‹ã®ã§ã™ãŒã€DDDã«CQRSã‚’å°å…¥ã—ãªã‹ã£ãŸã“ã¨ã«ã‚ˆã‚‹è‹¦åŠ´ã¾ã§è¨€åŠã—ãŸè¨˜äº‹ãŒã‚ã¾ã‚Šè¦‹å½“ãŸã‚‰ãªã‹ã£ãŸãŸã‚ã€ç°¡å˜ãªDDDã¨CQRSã®èª¬æ˜ã¨å®Ÿä¾‹ã‚’é€šã—ã¦ã€CQRSã‚’ä½¿ã‚ãªã„DDDã®å•é¡Œç‚¹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚ä»¥ä¸‹ãŒå•é¡Œç‚¹ä¸€è¦§ã§ã™ã€‚
- N+1å•é¡ŒãŒç™ºç”Ÿã—ã‚„ã™ã„
- ãƒªãƒã‚¸ãƒˆãƒªã®è¿”ã‚Šå€¤ã¯é›†ç´„å˜ä½ã§ã‚ã‚‹ãŸã‚ã€ä¸å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãŒå¿…è¦
- è¤‡æ•°ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã¨ã£ã¦ããŸé›†ç´„ã‚’çµ„ã¿åˆã‚ã›ã¦ã‚¯ãƒ©ã‚¤ãƒ³ãƒˆã®ãŸã‚ã«DTOã®è©°ã‚æ›¿ãˆã‚’è¡Œã†å¿…è¦ãŒã‚ã‚‹
- ãã‚‚ãã‚‚ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ã‚ãªã„

ä»¥ä¸‹ã§å®Ÿä¾‹ã‚’é€šã—ã¦ä¸Šè¨˜ã®ã‚ˆã†ãªå•é¡ŒãŒèµ·ã“ã‚‹åŸå› ã‚’è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

# DDD
æœ¬ç« ã§ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•è¨­è¨ˆ(DDD)ã®èª¬æ˜ã‚’ç°¡å˜ã«è¡Œã„ã¾ã™ã€‚DDDã‚’ã”å­˜ã˜ã®æ–¹ã¯ã“ã®ç« ã¯é£›ã°ã—ã¦[æ¬¡ã®ç« ](#CQRSã‚’ä½¿ç”¨ã—ãªã„DDDã®å•é¡Œç‚¹)

:::details ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«
DDDã§ã¯é–‹ç™ºã‚’è¡Œã†ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®å¯¾è±¡é ˜åŸŸï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰ã®å®Ÿä½“ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘ã®ã‚ˆã†ã«ã‚¯ãƒ©ã‚¹ç­‰ã«è½ã¨ã—è¾¼ã¿ã€ãã®æŒ¯ã‚‹èˆã„ã‚’è¡¨ç¾ã—ã¾ã™ã€‚ä¾‹ãˆã°å­¦æ ¡ã®éƒ¨æ´»ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹éš›ã€å„éƒ¨æ´»å‹•ã‚„ç”Ÿå¾’ã¨ã„ã£ãŸç¾å®Ÿä¸–ç•Œã®å®Ÿä½“ã‚’ãã®ã¾ã¾ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¯ãƒ©ã‚¹ã«è½ã¨ã—è¾¼ã¿ã¾ã™ã€‚
```Python
# éƒ¨æ´»
class Club:
    def __init__(self, id, name, students_ids):
        self.id = id
        self.name = name                 # éƒ¨æ´»å
        self.student_ids = students_ids  # éƒ¨æ´»ã«æ‰€å±ã—ã¦ã„ã‚‹ç”Ÿå¾’ã®ID

    # å…¥éƒ¨
    def join(self, student_id):
        if len(self.student_ids) > MAX_NUM_MEMBER:
            raise RuntimeError(f"éƒ¨æ´»ã®äººæ•°ã¯{MAX_NUM_MEMBER}äººã¾ã§ã§ã™")

        self.student_ids.add(student_id)

    # é€€éƒ¨
    def leave(self, student_id):
        if student_id not in self.student_ids:
            raise RuntimeError(f"{student_id}ã¯éƒ¨æ´»ã«å‚åŠ ã—ã¦ã„ã¾ã›ã‚“")

        self.student_ids.remove(student_id)


# ç”Ÿå¾’
class Student:
    def __init__(self, id, name):
        self.id = id
        self.name = name

```
ã‚¯ãƒ©ã‚¹ã«ã€ŒæŒ¯ã‚‹èˆã„ã‚’è¡¨ç¾ã™ã‚‹ã€ã¨ã„ã†ã®ã¯ã€ä¾‹ãˆã°ä¸Šè¨˜ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã“ã¨ã‚’æŒ‡ã—ã¾ã™ã€‚
- ã‚ã‚‹å­¦ç”ŸãŒéƒ¨æ´»ã«å…¥éƒ¨ã™ã‚‹ã“ã¨ã‚’`join`ãƒ¡ã‚½ãƒƒãƒ‰ã§è¡¨ç¾
- éƒ¨æ´»ã«ã¯äººæ•°ã®ä¸Šé™ãŒã‚ã‚‹ã“ã¨ã‚’`join`ãƒ¡ã‚½ãƒƒãƒ‰ã®ifæ–‡ãƒã‚§ãƒƒã‚¯ã§è¡¨ç¾

ã“ã®ã‚ˆã†ã«å¯¾è±¡é ˜åŸŸ(ãƒ‰ãƒ¡ã‚¤ãƒ³)ã®å®Ÿä½“ã‚’è½ã¨ã—è¾¼ã‚“ã ã‚¯ãƒ©ã‚¹ç­‰ã®ã“ã¨ã‚’**ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«**ã¨ã„ã„ã¾ã™[^1]ã€‚éƒ¨æ´»ã«äººãŒå…¥ã‚‹å…¥éƒ¨ã¨ã„ã†æŒ¯ã‚‹èˆã„ã‚„éƒ¨æ´»ã®äººæ•°åˆ¶é™ã¨ã„ã£ãŸã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ«ãƒ¼ãƒ«ã‚„åˆ¶ç´„ã‚’ãƒ¢ãƒ‡ãƒ«ã«ã¾ã¨ã‚ã¦è¡¨ç¾ã™ã‚‹ã“ã¨ã§ã€ï¼ˆãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜æ–¹æ³•ã‚„ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ–¹æ³•ãªã©ã«ä¾å­˜ã—ãªã„ï¼‰ãƒ‰ãƒ¡ã‚¤ãƒ³ã®çŸ¥è­˜ãŒä»–ãƒ¬ã‚¤ãƒ¤ãƒ¼ãªã©ã«æµå‡ºã™ã‚‹ã“ã¨ãŒé˜²ã’ã¾ã™ã€‚ã¾ãŸã€ã“ã®`Club`ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚ã°éƒ¨æ´»ã®äººæ•°ã®åˆ¶é™ãŒã‚ã‹ã‚‹ã‚ˆã†ã«ã€è‡ªèº«ãŒãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆçš„ãªæ„å‘³åˆã„ã‚‚ã‚‚ã¡ã€ä¿å®ˆæ€§ã‚„å¯èª­æ€§ã‚‚é«˜ã¾ã‚Šã¾ã™ã€‚Pythonã§ã¯é›£ã—ã„ã§ã™ãŒã€ä»–ã®è¨€èªã§ã¯`student_ids`ã‚’privateãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã™ã‚‹ã“ã¨ã§`student_ids`ã‚’å¤–éƒ¨ã‹ã‚‰æ“ä½œã•ã‚Œã‚‹ã“ã¨ã‚’é˜²ãã“ã¨ãŒã§ãã€ã“ã®ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ“ä½œã§ãã‚‹ã®ã¯ã‚ãã¾ã§ã‚‚ã€Œå…¥éƒ¨ã€ã¨ã€Œé€€éƒ¨ã€ã«å¯¾å¿œã™ã‚‹`join`ã¨`leave`ãƒ¡ã‚½ãƒƒãƒ‰ã«é™å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’privateã«ã™ã‚‹ã“ã¨ã§ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã®çŠ¶æ…‹ã‚’å¤‰æ›´ã™ã‚‹ã®ã¯ãã“ã«è¨˜è¿°ã•ã‚ŒãŸæŒ¯ã‚‹èˆã„ã«é™å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

[^1]: ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã«ã¯å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã“ã§ã¯å‰²æ„›ã—ã¾ã™ã€‚
:::

:::details ãƒªãƒã‚¸ãƒˆãƒª
ãƒªãƒã‚¸ãƒˆãƒªã§ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ãŒæ‰±ã‚ãªã‹ã£ãŸãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚„æ°¸ç¶šåŒ–ã¨ã„ã£ãŸå‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯è‡ªèº«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®çŠ¶æ…‹ã‚’å¤‰æ›´ã—ã¾ã™ãŒã€ãã®çµæœã‚’DBç­‰ã«æ°¸ç¶šåŒ–ã™ã‚‹ã®ãŒãƒªãƒã‚¸ãƒˆãƒªã®å½¹å‰²ã§ã™ã€‚ã¾ãŸDBç­‰ã«æ°¸ç¶šã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚ã‚‹çŠ¶æ…‹ã‚’æŒã¤ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã®å–å¾—ã‚’è¡Œã†ã®ã‚‚ãƒªãƒã‚¸ãƒˆãƒªã®å½¹å‰²ã§ã™ã€‚

ã§ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã®èª¬æ˜ã§ã¨ã‚Šã‚ã’ãŸ`Club`ã¨`Student`ã®ä¾‹ã‚’ã‚‚ã¨ã«ãƒªãƒã‚¸ãƒˆãƒªã®å…·ä½“ä¾‹ã‚’ä»¥ä¸‹ã§èª¬æ˜ã—ã¾ã™ã€‚ä»Šå›ã¯ç°¡å˜ã®ãŸã‚ã€å„ç”Ÿå¾’ã¯å…¼éƒ¨ã¯ã§ããªã„ã¨ã„ã†è¨­å®šã«ã—ã€`Club`ã¨`Student`ã¯1:nã®é–¢ä¿‚ã¨ã—ã¾ã™ã€‚DBã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãª`clubs`ãƒ†ãƒ¼ãƒ–ãƒ«ã¨`students`ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚

- clubsãƒ†ãƒ¼ãƒ–ãƒ«

	| id | name |
	| ---- | ---- |
	| club_id1 | é‡çƒéƒ¨ |
	| club_id2 | è»½éŸ³éƒ¨ |

- studentsãƒ†ãƒ¼ãƒ–ãƒ«
	| id | name | club_id |
	| ---- | ---- | ---- |
	| student_id1 | å¤§è°·ç¿”å¹³  | club_id1 |
	| student_id2 | ãƒ´ã‚¡ãƒ³ãƒ»ãƒ˜ã‚¤ãƒ¬ãƒ³ | club_id2 |
	| student_id3 | å¹³æ²¢å”¯ | club_id2 |

ã“ã®ã¨ãã€ãƒªãƒã‚¸ãƒˆãƒªã®å®Ÿè£…ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚


```Python
class ClubRepository:
    def __init__(self, db):
        self.db = db

    # club_idã«å¯¾å¿œã™ã‚‹Clubã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã‚’å–å¾—ã™ã‚‹
    def get(self, club_id) -> Optional[Club]:
        query = (
            "SELECT clubs.id, clubs.name, students.id "
            "FROM clubs "
            "LEFT JOIN students "
            "ON clubs.id = students.club_id "
            "WHERE clubs.id = %s"
        )
        with self.db.cursor() as cursor:
            cursor.execute(query, (club_id,))

            rows = list(cursor.fetchall())
            if len(rows) == 0:
                return None

            student_ids = []
            for (club_id, club_name, student_id) in :
                student_ids.append(student_id)

        return Club(id=club_id, name=club_name, student_ids=student_ids)

    # Clubã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã‚’DBã«æ°¸ç¶šåŒ–ã™ã‚‹
    def save(self, club):
        old_club = self.get(club.id)
        with self.db.cursor() as cursor:
            query = (
                "INSERT INTO clubs "
                "VALUES (%s, %s) "
                "ON DUPLICATE KEY UPDATE name=%s"
            )
            cursor.execute(query, (club.id, club.name, club.name))

            query = (
                "UPDATE students "
                "SET club_id=%s "
                "WHERE student_id in (" + ",".join(["%s"] * len(club.student_ids)) + ")"
            )
            cursor.execute(query, tuple(old_club.student_ids))

            cursor.commit()

```
ä¸Šè¨˜ãƒªãƒã‚¸ãƒˆãƒªã§ã¯`get`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚ã‚‹`club_id`ã‚’æŒã¤`Club`ã®å–å¾—ã€`save`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚ã‚‹`Club`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æ°¸ç¶šåŒ–ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

:::


### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
ã“ã“ã§ä¸Šè¨˜ã®

# CQRSã‚’ä½¿ç”¨ã—ãªã„DDDã®å•é¡Œç‚¹

